var beats_per_minute = prompt("Please enter a beats per minute", 60);
//var score = {"name": "House Of the Rising Sun", "notes": [{"is_note": true, "name": "G", "octave": 3, "quarterLength": "0.5"}, {"is_note": true, "name": "C", "octave": 4, "quarterLength": "2.0"}, {"is_note": true, "name": "C", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "D", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "Eb", "octave": 4, "quarterLength": "2.0"}, {"is_note": true, "name": "Eb", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "F", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "G", "octave": 4, "quarterLength": "1.5"}, {"is_note": true, "name": "F", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "Eb", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "Eb", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "C", "octave": 4, "quarterLength": "2.0"}, {"is_note": true, "name": "C", "octave": 5, "quarterLength": "0.5"}, {"is_note": true, "name": "C", "octave": 5, "quarterLength": "1.5"}, {"is_note": true, "name": "C", "octave": 5, "quarterLength": "1.0"}, {"is_note": true, "name": "C", "octave": 5, "quarterLength": "0.5"}, {"is_note": true, "name": "Bb", "octave": 4, "quarterLength": "2.0"}, {"is_note": true, "name": "Bb", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "C", "octave": 5, "quarterLength": "0.5"}, {"is_note": true, "name": "G", "octave": 4, "quarterLength": "4.0"}, {"is_note": true, "name": "G", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "C", "octave": 5, "quarterLength": "1.0"}, {"is_note": true, "name": "C", "octave": 5, "quarterLength": "0.5"}, {"is_note": true, "name": "C", "octave": 5, "quarterLength": "2.0"}, {"is_note": true, "name": "C", "octave": 5, "quarterLength": "0.5"}, {"is_note": true, "name": "C", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "Eb", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "Eb", "octave": 4, "quarterLength": "2.0"}, {"is_note": true, "name": "F", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "G", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "G", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "F", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "Eb", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "Eb", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "C", "octave": 4, "quarterLength": "1.5"}, {"is_note": true, "name": "G", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "G", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "F", "octave": 4, "quarterLength": "1.5"}, {"is_note": true, "name": "Eb", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "C", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "G", "octave": 3, "quarterLength": "1.5"}, {"is_note": true, "name": "G", "octave": 3, "quarterLength": "0.5"}, {"is_note": true, "name": "Bb", "octave": 3, "quarterLength": "0.5"}, {"is_note": true, "name": "C", "octave": 4, "quarterLength": "4.0"}, {"is_note": true, "name": "C", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "G", "octave": 4, "quarterLength": "3.0"}, {"is_note": true, "name": "G", "octave": 4, "quarterLength": "0.75"}, {"is_note": true, "name": "Bb", "octave": 4, "quarterLength": "0.75"}, {"is_note": true, "name": "G", "octave": 4, "quarterLength": "0.75"}, {"is_note": true, "name": "F", "octave": 4, "quarterLength": "0.75"}, {"is_note": true, "name": "G", "octave": 4, "quarterLength": "1.5"}], "beatsPerMeasure": 6, "keySignature": "Eb", "beatValue": 8}
//var score = {"name": "Happy Birthday To You","notes": [{"is_note": true, "name": "C", "octave": 4, "quarterLength": "0.75"}, {"is_note": true, "name": "C", "octave": 4, "quarterLength": "0.25"}, {"is_note": true, "name": "D", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "C", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "F", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "E", "octave": 4, "quarterLength": "2.0"}, {"is_note": true, "name": "C", "octave": 4, "quarterLength": "0.75"}, {"is_note": true, "name": "C", "octave": 4, "quarterLength": "0.25"}, {"is_note": true, "name": "D", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "C", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "G", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "F", "octave": 4, "quarterLength": "2.0"}, {"is_note": true, "name": "C", "octave": 4, "quarterLength": "0.75"}, {"is_note": true, "name": "C", "octave": 4, "quarterLength": "0.25"}, {"is_note": true, "name": "C", "octave": 5, "quarterLength": "1.0"}, {"is_note": true, "name": "A", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "F", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "E", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "D", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "Bb", "octave": 4, "quarterLength": "0.75"}, {"is_note": true, "name": "Bb", "octave": 4, "quarterLength": "0.25"}, {"is_note": true, "name": "A", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "F", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "G", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "F", "octave": 4, "quarterLength": "3.0"}], "beatsPerMeasure": 3, "keySignature": "F", "beatValue": 4}
//var score = {"name": "Joy To The World","notes": [{"is_note": true, "name": "G#", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "G", "octave": 4, "quarterLength": "0.75"}, {"is_note": true, "name": "F", "octave": 4, "quarterLength": "0.25"}, {"is_note": true, "name": "Eb", "octave": 4, "quarterLength": "1.5"}, {"is_note": true, "name": "C#", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "C", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "Bb", "octave": 3, "quarterLength": "1.0"}, {"is_note": true, "name": "G#", "octave": 3, "quarterLength": "1.5"}, {"is_note": true, "name": "Eb", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "F", "octave": 4, "quarterLength": "1.5"}, {"is_note": true, "name": "F", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "G", "octave": 4, "quarterLength": "1.5"}, {"is_note": true, "name": "G", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "G#", "octave": 4, "quarterLength": "1.5"}, {"is_note": true, "name": "G#", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "G#", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "G", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "F", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "Eb", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "Eb", "octave": 4, "quarterLength": "0.75"}, {"is_note": true, "name": "C#", "octave": 4, "quarterLength": "0.25"}, {"is_note": true, "name": "C", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "G#", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "G#", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "G", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "F", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "Eb", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "Eb", "octave": 4, "quarterLength": "0.75"}, {"is_note": true, "name": "C#", "octave": 4, "quarterLength": "0.25"}, {"is_note": true, "name": "C", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "C", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "C", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "C", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "C", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "C", "octave": 4, "quarterLength": "0.25"}, {"is_note": true, "name": "C#", "octave": 4, "quarterLength": "0.25"}, {"is_note": true, "name": "Eb", "octave": 4, "quarterLength": "1.5"}, {"is_note": true, "name": "C#", "octave": 4, "quarterLength": "0.25"}, {"is_note": true, "name": "C", "octave": 4, "quarterLength": "0.25"}, {"is_note": true, "name": "Bb", "octave": 3, "quarterLength": "0.5"}, {"is_note": true, "name": "Bb", "octave": 3, "quarterLength": "0.5"}, {"is_note": true, "name": "Bb", "octave": 3, "quarterLength": "0.5"}, {"is_note": true, "name": "Bb", "octave": 3, "quarterLength": "0.25"}, {"is_note": true, "name": "C", "octave": 4, "quarterLength": "0.25"}, {"is_note": true, "name": "C#", "octave": 4, "quarterLength": "1.5"}, {"is_note": true, "name": "C", "octave": 4, "quarterLength": "0.25"}, {"is_note": true, "name": "Bb", "octave": 3, "quarterLength": "0.25"}, {"is_note": true, "name": "G#", "octave": 3, "quarterLength": "0.5"}, {"is_note": true, "name": "G#", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "F", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "Eb", "octave": 4, "quarterLength": "0.75"}, {"is_note": true, "name": "C#", "octave": 4, "quarterLength": "0.25"}, {"is_note": true, "name": "C", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "C#", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "C", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "Bb", "octave": 3, "quarterLength": "1.0"}, {"is_note": true, "name": "G#", "octave": 3, "quarterLength": "2.0"}], "beatsPerMeasure": 2, "keySignature": "Ab", "beatValue": 4}
//var score = {"name": "We Wish You A Merry Christmas","notes": [{"is_note": true, "name": "Bb", "octave": 3, "quarterLength": "1.0"}, {"is_note": true, "name": "Eb", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "Eb", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "F", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "Eb", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "D", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "C", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "C", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "C", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "F", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "F", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "G", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "F", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "Eb", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "D", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "D", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "D", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "G", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "G", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "G#", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "G", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "F", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "Eb", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "C", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "Bb", "octave": 3, "quarterLength": "0.5"}, {"is_note": true, "name": "Bb", "octave": 3, "quarterLength": "0.5"}, {"is_note": true, "name": "C", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "F", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "D", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "Eb", "octave": 4, "quarterLength": "2.0"}, {"is_note": true, "name": "Bb", "octave": 3, "quarterLength": "1.0"}, {"is_note": true, "name": "Eb", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "Eb", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "Eb", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "D", "octave": 4, "quarterLength": "2.0"}, {"is_note": true, "name": "D", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "Eb", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "D", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "C", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "Bb", "octave": 3, "quarterLength": "2.0"}, {"is_note": true, "name": "F", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "G", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "F", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "F", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "Eb", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "Eb", "octave": 4, "quarterLength": "0.5"}, {"is_note": true, "name": "Bb", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "Bb", "octave": 3, "quarterLength": "1.0"}, {"is_note": true, "name": "Bb", "octave": 3, "quarterLength": "0.5"}, {"is_note": true, "name": "Bb", "octave": 3, "quarterLength": "0.5"}, {"is_note": true, "name": "C", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "F", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "D", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "Eb", "octave": 4, "quarterLength": "2.0"}], "beatsPerMeasure": 3, "keySignature": "Eb", "beatValue": 4}
var score = {"notes": [{"is_note": true, "name": "Eb", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "Eb", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "F", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "G", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "Eb", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "G", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "F", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "Bb", "octave": 3, "quarterLength": "1.0"}, {"is_note": true, "name": "Eb", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "Eb", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "F", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "G", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "Eb", "octave": 4, "quarterLength": "2.0"}, {"is_note": true, "name": "D", "octave": 4, "quarterLength": "2.0"}, {"is_note": true, "name": "Eb", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "Eb", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "F", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "G", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "G#", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "G", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "F", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "Eb", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "D", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "Bb", "octave": 3, "quarterLength": "1.0"}, {"is_note": true, "name": "C", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "D", "octave": 4, "quarterLength": "1.0"}, {"is_note": true, "name": "Eb", "octave": 4, "quarterLength": "2.0"}, {"is_note": true, "name": "Eb", "octave": 4, "quarterLength": "2.0"}], "beatsPerMeasure": 4, "name": "Yankee Doodle", "beatValue": 4, "keySignature": "Eb"}
var beats_per_measure = score.beatsPerMeasure;
var header = document.getElementById("header")
header.innerHTML = '<h1 id="header" align="center" itemprop="headline">' + score.name + '</h1>'
var beat_value = score.beatValue;
var keySig = score.keySignature;
var bars = getBars(score.notes);
var audioContext = new AudioContext();
// Configure the rendering context.
createStaff(keySig, bars);
var currentNote = [];

var readStart = function(stream) {
	var source = audioContext.createMediaStreamSource(stream);
	var processor = audioContext.createScriptProcessor(4096, 1, 1);
	var count = 0;
	var sixteenthNoteSampleBufferSize =  4096;
	var sixteenthNoteSamples = [];
	var leftoverSamples = [];

	source.connect(processor);
	processor.connect(audioContext.destination);
	processor.onaudioprocess = function(e) {
		count += 4096;
		count = count % 44100;
		// Do something with the data, i.e Convert this to WAV
		var channelData = e.inputBuffer.getChannelData(0);
		for (var i = 0; i < channelData.length; i++) {
			sixteenthNoteSamples.push(channelData[i])
		}
		if (sixteenthNoteSamples.length < sixteenthNoteSampleBufferSize) {
			currentNote = [];
			return;
		}
		leftoverSamples = sixteenthNoteSamples.slice(sixteenthNoteSampleBufferSize)
		sixteenthNoteSamples = sixteenthNoteSamples.slice(0, sixteenthNoteSampleBufferSize)
		var max = 0;
		for (var i = 0; i < sixteenthNoteSamples.length; i++) {
			max = Math.max(max, Math.abs(sixteenthNoteSamples[i]))
		}
		if (max > 0.1) {
			freq = estimateFrequency(sixteenthNoteSamples);
			if (freq != -1) {
				currentNote = estimateNote(freq);
			} else {
				currentNote = [];
			}
		} else {
			currentNote = [];
		}
		sixteenthNoteSamples = leftoverSamples;
	};
	playSound(audioContext, beats_per_minute, 1);
};

navigator.mediaDevices.getUserMedia({ audio: true, video: false })
	.then(readStart);
